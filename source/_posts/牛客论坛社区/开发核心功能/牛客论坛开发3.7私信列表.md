---
title: 牛客论坛项目-私信列表
categories:
- nowcoder
tags:
- core_function
- nowcoder
---
<meta name="referrer" content="no-referrer"/>

## 内容

**本节包括：**

- 私信列表
- 私信详情
- 未读消息数

<!--more-->

## 总体步骤

私信列表

- 查询当前用户的会话列表，
- 每个会话只显示一条最新的私信
- 支持分页显示。 

私信详情

- 查询某个会话所包含的私信
- 支持分页显示

## 具体实现

### message表

~~~sql
create table message
(
    id              int auto_increment
        primary key,
    from_id         int         null,
    to_id           int         null,
    conversation_id varchar(45) not null,
    content         text        null,
    status          int         null comment '0-未读;1-已读;2-删除;',
    create_time     timestamp   null
)
~~~

### Message-实体

~~~java
@Data
public class Message {

    private int id;
    private int fromId;
    private int toId;
    private String conversationId;
    private String content;
    private int status;
    private Date createTime;
}
~~~

### 创建MessageMapper-数据操作

~~~java
@Mapper
public interface MessageMapper {

    // 查询当前用户的会话列表,针对每个会话只返回一条最新的私信.
    List<Message> selectConversations(int userId, int offset, int limit);

    // 查询当前用户的会话数量.
    int selectConversationCount(int userId);

    // 查询某个会话所包含的私信列表.
    List<Message> selectLetters(String conversationId, int offset, int limit);

    // 查询某个会话所包含的私信数量.
    int selectLetterCount(String conversationId);

    // 查询未读私信的数量
    int selectLetterUnreadCount(int userId, String conversationId);
}
~~~

### 创建message-mapper.xml

~~~xml
<select id="selectConversations" resultType="Message">
    select <include refid="selectFields"></include>
    from message
    where id in (
        select max(id) from message
        where status != 2
        and from_id != 1
        and (from_id = #{userId} or to_id = #{userId})
        group by conversation_id
    )
    order by id desc
    limit #{offset}, #{limit}
</select>
~~~

按照conversation_id分组，每一组只要最新那个conversation的id，将这些id进行降序排序

~~~xml
<select id="selectConversationCount" resultType="java.lang.Integer">
    select count(m.maxid)
    from (select max(id) as maxid
          from message
          where status != 2
        and from_id != 1
        and (from_id = #{userId}
             or to_id = #{userId})
          group by conversation_id) as m
</select>

<select id="selectLetters" resultType="com.hdb.community.entity.Message">
    select
    <include refid="selectFields"></include>
    from message
    where status != 2
    and from_id != 1
    and conversation_id = #{conversationId}
    order by id desc
    limit #{offset}, #{limit}
</select>

<select id="selectLetterCount" resultType="java.lang.Integer">
    select count(id)
    from message
    where status != 2
    and from_id != 1
    and conversation_id = #{conversationId}
</select>

<select id="selectLetterUnreadCount" resultType="java.lang.Integer">
    select count(id)
    from message
    where status = 0
    and from_id != 1
    and to_id = #{userId}
    <if test="conversationId!=null">
        and conversation_id = #{conversationId}
    </if>
</select>
~~~

### 测试mapper

~~~java
@Autowired
private LoginTicketMapper loginTicketMapper;
@Test
public void testSelectLetters() {
    List<Message> list = messageMapper.selectConversations(111, 0, 20);
    for (Message message : list) {
        System.out.println(message);
    }

    int count = messageMapper.selectConversationCount(111);
    System.out.println(count);

    list = messageMapper.selectLetters("111_112", 0, 10);
    for (Message message : list) {
        System.out.println(message);
    }

    count = messageMapper.selectLetterCount("111_112");
    System.out.println(count);

    count = messageMapper.selectLetterUnreadCount(131, "111_131");
    System.out.println(count);

}
~~~

### 创建messageService

~~~java
@Service
public class MessageService {
    @Autowired
    private MessageMapper messageMapper;

    public List<Message> findConversations(int userId, int offset, int limit) {
        return messageMapper.selectConversations(userId, offset, limit);
    }

    public int findConversationCount(int userId) {
        return messageMapper.selectConversationCount(userId);
    }

    public List<Message> findLetters(String conversationId, int offset, int limit) {
        return messageMapper.selectLetters(conversationId, offset, limit);
    }

    public int findLetterCount(String conversationId) {
        return messageMapper.selectLetterCount(conversationId);
    }

    public int findLetterUnreadCount(int userId, String conversationId) {
        return messageMapper.selectLetterUnreadCount(userId, conversationId);
    }

}
~~~

### 创建MessageController

~~~java
@Controller
public class MessageController {
    @Autowired
    private MessageService messageService;

    @Autowired
    private HostHolder hostHolder;

    @Autowired
    private UserService userService;

    // 私信列表
    @RequestMapping(path = "/letter/list", method = RequestMethod.GET)
    public String getLetterList(Model model, Page page) {
        User user = hostHolder.getUser();
        // 分页信息
        page.setLimit(5);
        page.setPath("/letter/list");
        page.setRows(messageService.findConversationCount(user.getId()));

        // 会话列表
        List<Message> conversationList = messageService.findConversations(
                user.getId(), page.getOffset(), page.getLimit());
        List<Map<String, Object>> conversations = new ArrayList<>();
        if (conversationList != null) {
            for (Message message : conversationList) {
                Map<String, Object> map = new HashMap<>();
                map.put("conversation", message);
                map.put("letterCount", messageService.findLetterCount(message.getConversationId()));
                map.put("unreadCount", messageService.findLetterUnreadCount(user.getId(), message.getConversationId()));
                int targetId = user.getId() == message.getFromId() ? message.getToId() : message.getFromId();
                map.put("target", userService.findUserById(targetId));

                conversations.add(map);
            }
        }
        model.addAttribute("conversations", conversations);

        // 查询未读消息数量
        int letterUnreadCount = messageService.findLetterUnreadCount(user.getId(), null);
        model.addAttribute("letterUnreadCount", letterUnreadCount);

        return "/site/letter";
    }
}

~~~

### 修改index.html

~~~html
<a class="nav-link position-relative" th:href="@{/letter/list}">消息<span class="badge badge-danger">12</span></a>
~~~

### 修改letter.html

~~~html
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<link rel="stylesheet" th:href="@{/css/global.css}" />
<link rel="stylesheet" th:href="@{/css/letter.css}" />
<script th:src="@{/js/global.js}"></script>
<script th:src="@{/js/letter.js}"></script>
~~~

复用头部

~~~html
<header class="bg-dark sticky-top" th:replace="index::header">
~~~

模板内容

~~~html
<a class="nav-link position-relative active" th:href="@{/letter/list}">
    朋友私信<span class="badge badge-danger" th:text="${letterUnreadCount}" th:if="${letterUnreadCount!=0}">3</span>
</a>
~~~

~~~html
<!-- 私信列表 -->
<ul class="list-unstyled">
    <li class="media pb-3 pt-3 mb-3 border-bottom position-relative" th:each="map:${conversations}">
        <span class="badge badge-danger" th:text="${map.unreadCount}" th:if="${map.unreadCount!=0}">3</span>
        <a href="profile.html">
            <img th:src="${map.target.headerUrl}" class="mr-4 rounded-circle user-header" alt="用户头像">
        </a>
        <div class="media-body">
            <h6 class="mt-0 mb-3">
                <span class="text-success" th:utext="${map.target.username}">落基山脉下的闲人</span>
                <span class="float-right text-muted font-size-12"
                      th:text="${#dates.format(map.conversation.createTime,'yyyy-MM-dd HH:mm:ss')}">2019-04-28 14:13:25</span>
            </h6>
            <div>
                <a href="letter-detail.html" th:utext="${map.conversation.content}">米粉车, 你来吧!</a>
                <ul class="d-inline font-size-12 float-right">
                    <li class="d-inline ml-2"><a href="#" class="text-primary">共<i
                            th:text="${map.letterCount}">5</i>条会话</a></li>
                </ul>
            </div>
        </div>
    </li>
</ul>
~~~

分页

~~~html
<nav class="mt-5" th:replace="index::pagination">
~~~

### 实验结果1

<img src="https://gitee.com/hollis7/pictures/raw/master/2024/06/19/23694_image-20240619170414508.png" alt="image-20240619170414508" style="zoom: 50%;" />

### 私信详情-续写MessageController

~~~java
@RequestMapping(path = "/letter/detail/{conversationId}", method = RequestMethod.GET)
public String getLetterDetail(@PathVariable("conversationId") String conversationId, Page page, Model model) {
    // 分页信息
    page.setLimit(5);
    page.setPath("/letter/detail/" + conversationId);
    page.setRows(messageService.findLetterCount(conversationId));

    // 私信列表
    List<Message> letterList = messageService.findLetters(conversationId, page.getOffset(), page.getLimit());
    List<Map<String, Object>> letters = new ArrayList<>();
    if (letterList != null) {
        for (Message message : letterList) {
            Map<String, Object> map = new HashMap<>();
            map.put("letter", message);
            map.put("fromUser", userService.findUserById(message.getFromId()));
            letters.add(map);
        }
    }
    model.addAttribute("letters", letters);

    // 私信目标
    model.addAttribute("target", getLetterTarget(conversationId));
    
    return "/site/letter-detail";
}
private User getLetterTarget(String conversationId) {
        String[] ids = conversationId.split("_");
        int id0 = Integer.parseInt(ids[0]);
        int id1 = Integer.parseInt(ids[1]);

        if (hostHolder.getUser().getId() == id0) {
            return userService.findUserById(id1);
        } else {
            return userService.findUserById(id0);
        }
    }
~~~

私信详情-续写letter

~~~html
<a th:href="@{|/letter/detail/${map.conversation.conversationId}|}" th:utext="${map.conversation.content}">米粉车, 你来吧!</a>
~~~

### 改写letter-detail.html

~~~html
<!-- 私信列表 -->
<ul class="list-unstyled mt-4">
    <li class="media pb-3 pt-3 mb-2" th:each="map:${letters}">
        <a href="profile.html">
            <img th:src="${map.fromUser.headerUrl}" class="mr-4 rounded-circle user-header" alt="用户头像" >
        </a>
        <div class="toast show d-lg-block" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="mr-auto" th:utext="${map.fromUser.username}">落基山脉下的闲人</strong>
                <small th:text="${#dates.format(map.letter.createTime,'yyyy-MM-dd HH:mm:ss')}">2019-04-25 15:49:32</small>
                <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="toast-body" th:utext="${map.letter.content}">
                君不见, 黄河之水天上来, 奔流到海不复回!
            </div>
        </div>
    </li>
</ul>
~~~

分页

~~~html
<nav class="mt-5" th:replace="index::pagination">
~~~

修改返回

~~~html
<button type="button" class="btn btn-secondary btn-sm" onclick="back()">返回</button>
<script>
function back() {
    location.href = CONTEXT_PATH + "/letter/list";
}
</script>
~~~

### 实验结果2

<img src="https://gitee.com/hollis7/pictures/raw/master/2024/06/19/48568_image-20240619192734950.png" alt="image-20240619192734950" style="zoom:50%;" />
