---
title: 牛客论坛项目-事务管理
categories:
- nowcoder
tags:
- core_function
- nowcoder
---
<meta name="referrer" content="no-referrer"/>

## 内容

**本节包括：**

- 事务概念
- 事务特性
- 事务隔离性
- 事务隔离级别（表）
- spring事务管理

<!--more-->

## 事务概念

事务是由N步数据库操作序列组成的逻辑执行单元，这系列操作要么全执行，要么全放弃执行。

## 事务特性

原子性(Atomicity):事务是应用中不可再分的最小执行体。
一致性(Consistency)：事务执行的结果，须使数据从一个一致性状态，变为另一个一致性状态。
隔离性(Isolation)：各个事务的执行互不干扰，任何事务的内部操作对其他的事务都是隔离的。
持久性(Durability)：事务一旦提交，对数据所做的任何改变都要记录到永久存储器中。

## 事务隔离性

### 常见隔离级别

- Read Uncommitted:读取未提交的数据。
- Read Committed:读取已提交的数据。
- Repeatable Read:可重复读。
- Serializable:串行化。

### 常见并发异常

#### 第一类丢失更新

某一个事务的回滚，导致另外一个事务已更新的数据丢失了。

<img src="https://gitee.com/hollis7/pictures/raw/master/2024/06/14/69313_image-20240614170353132.png" alt="image-20240614170353132" style="zoom: 33%;" />

#### 第二类丢失更新

某一个事务的提交，导致另外一个事务已更新的数据丢失了。

<img src="https://gitee.com/hollis7/pictures/raw/master/2024/06/14/51455_image-20240614170555122.png" alt="image-20240614170555122" style="zoom:33%;" />

#### 脏读

某一个事务，读取了另外一个事务未提交的数据。

<img src="https://gitee.com/hollis7/pictures/raw/master/2024/06/14/56222_image-20240614170735129.png" alt="image-20240614170735129" style="zoom:33%;" />

#### 不可重复读

某一个事务，极短时间内对同一个数据前后读取的结果不一致。

<img src="https://gitee.com/hollis7/pictures/raw/master/2024/06/14/56394_image-20240614171128226.png" alt="image-20240614171128226" style="zoom:33%;" />

#### 幻读

某一个事务，对同一个表前后查询到的行数不一致。

<img src="https://gitee.com/hollis7/pictures/raw/master/2024/06/14/46134_image-20240614171234998.png" alt="image-20240614171234998" style="zoom:33%;" />

### 事务隔离级别解决的异常表

<img src="https://gitee.com/hollis7/pictures/raw/master/2024/06/14/50461_image-20240614171611207.png" alt="image-20240614171611207" style="zoom:33%;" />

## spring事务管理

### 声明式-@Transactional

~~~java
// REQUIRED: 支持当前事务(外部事务),如果不存在则创建新事务.
// REQUIRES_NEW: 创建一个新事务,并且暂停当前事务(外部事务).
// NESTED: 如果当前存在事务(外部事务),则嵌套在该事务中执行(独立的提交和回滚),否则就会REQUIRED一样.
@Transactional(isolation = Isolation.READ_COMMITTED, propagation = Propagation.REQUIRED)
public Object save1() {
    // 新增用户
    User user = new User();
    user.setUsername("alpha");
    user.setSalt(CommunityUtil.generateUUID().substring(0, 5));
    user.setPassword(CommunityUtil.md5("123" + user.getSalt()));
    user.setEmail("alpha@qq.com");
    user.setHeaderUrl("http://image.nowcoder.com/head/99t.png");
    user.setCreateTime(new Date());
    userMapper.insertUser(user);

    // 新增帖子
    DiscussPost post = new DiscussPost();
    post.setUserId(user.getId());
    post.setTitle("Hello");
    post.setContent("新人报道!");
    post.setCreateTime(new Date());
    discussPostMapper.insertDiscussPost(post);

    Integer.valueOf("abc");

    return "ok";
}
~~~

### 编程式-TransactionTemplate

~~~java
public Object save2() {
    transactionTemplate.setIsolationLevel(TransactionDefinition.ISOLATION_READ_COMMITTED);
    transactionTemplate.setPropagationBehavior(TransactionDefinition.PROPAGATION_REQUIRED);

    return transactionTemplate.execute(new TransactionCallback<Object>() {
        @Override
        public Object doInTransaction(TransactionStatus status) {
            // 新增用户
            User user = new User();
            user.setUsername("beta");
            user.setSalt(CommunityUtil.generateUUID().substring(0, 5));
            user.setPassword(CommunityUtil.md5("123" + user.getSalt()));
            user.setEmail("beta@qq.com");
            user.setHeaderUrl("http://image.nowcoder.com/head/999t.png");
            user.setCreateTime(new Date());
            userMapper.insertUser(user);

            // 新增帖子
            DiscussPost post = new DiscussPost();
            post.setUserId(user.getId());
            post.setTitle("你好");
            post.setContent("我是新人!");
            post.setCreateTime(new Date());
            discussPostMapper.insertDiscussPost(post);

            Integer.valueOf("abc");

            return "ok";
        }
    });
}
~~~

