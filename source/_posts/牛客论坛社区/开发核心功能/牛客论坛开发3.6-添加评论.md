---
title: 牛客论坛项目-添加评论
categories:
- nowcoder
tags:
- core_function
- nowcoder
---
<meta name="referrer" content="no-referrer"/>

## 内容

**本节包括：**

- 添加评论

<!--more-->

## 总体步骤

数据层

- 增加评论数据。
- 修改帖子的评论数量。

业务层

- 处理添加评论的业务：
- 先增加评论、再更新帖子的评论数量。

表现层

- 处理添加评论数据的请求。
- 设置添加评论的表单。

## 具体实现

### 续写commentMapper

~~~java
int insertComment(Comment comment);
~~~

对应mapper.xml

~~~xml
<sql id="insertFields">
    user_id
    , entity_type, entity_id, target_id, content, status, create_time
</sql>
<insert id="insertComment">
    insert into comment(<include refid="insertFields"></include>)
    values(#{userId},#{entityType},#{entityId},#{targetId},#{content},#{status},#{createTime})
</insert>
~~~

### 续写DiscussPostMapper

~~~java
int updateCommentCount(int id, int commentCount);
~~~

对应的mapper.xml

~~~java
<update id="updateCommentCount">
    update discuss_post
    set comment_count = #{commentCount}
    where id = #{id}
</update>
~~~

### 续写DiscussPostService

~~~java
public int updateCommentCount(int id, int commentCount) {
    return discussPostMapper.updateCommentCount(id, commentCount);
}
~~~

### 续写CommentService

~~~java
@Transactional(isolation = Isolation.READ_COMMITTED, propagation = Propagation.REQUIRED)
public int addComment(Comment comment) {
    if (comment == null) {
        throw new IllegalArgumentException("参数不能为空!");
    }

    // 添加评论
    comment.setContent(HtmlUtils.htmlEscape(comment.getContent()));
    comment.setContent(sensitiveFilter.filter(comment.getContent()));
    int rows = commentMapper.insertComment(comment);

    // 更新帖子评论数量
    if (comment.getEntityType() == ENTITY_TYPE_POST) {
        int count = commentMapper.selectCountByEntity(comment.getEntityType(), comment.getEntityId());
        discussPostService.updateCommentCount(comment.getEntityId(), count);
    }

    return rows;
}
~~~

### 创建CommentController

~~~java
@Controller
@RequestMapping("/comment")
public class CommentController {

    @Autowired
    private CommentService commentService;

    @Autowired
    private HostHolder hostHolder;

    @RequestMapping(path = "/add/{discussPostId}", method = RequestMethod.POST)
    public String addComment(@PathVariable("discussPostId") int discussPostId, Comment comment) {
        comment.setUserId(hostHolder.getUser().getId());
        comment.setStatus(0);
        comment.setCreateTime(new Date());
        commentService.addComment(comment);

        return "redirect:/discuss/detail/" + discussPostId;
    }

}
~~~

### 改写discuss-detail.html

#### 回复帖子

~~~java
<!-- 回帖输入 -->
<div class="container mt-3">
    <form class="replyform" method="post" th:action="@{|/comment/add/${post.id}|}">
        <p class="mt-3">
            <a name="replyform"></a>
            <textarea placeholder="在这里畅所欲言你的看法吧!" name="content"></textarea>
            <input type="hidden" name="entityType" value="1">
            <input type="hidden" name="entityId" th:value="${post.id}">
        </p>
        <p class="text-right">
            <button type="submit" class="btn btn-primary btn-sm">&nbsp;&nbsp;回&nbsp;&nbsp;帖&nbsp;&nbsp;</button>
        </p>
    </form>
</div>
~~~

#### 回复评论

~~~java
<form method="post" th:action="@{|/comment/add/${post.id}|}">
    <div>
        <input type="text" class="input-size" name="content" placeholder="请输入你的观点"/>
        <input type="hidden" name="entityType" value="2">
        <input type="hidden" name="entityId" th:value="${cvo.comment.id}">
    </div>
    <div class="text-right mt-2">
        <button type="submit" class="btn btn-primary btn-sm" onclick="#">&nbsp;&nbsp;回&nbsp;&nbsp;复&nbsp;&nbsp;</button>
    </div>
</form>
~~~

#### 回复特定的人

~~~java
<div th:id="|huifu-${rvoStat.count}|" class="mt-4 collapse">
    <form method="post" th:action="@{|/comment/add/${post.id}|}">
        <div>
            <input type="text" class="input-size" name="content" th:placeholder="|回复${rvo.user.username}|"/>
            <input type="hidden" name="entityType" value="2">
            <input type="hidden" name="entityId" th:value="${cvo.comment.id}">
            <input type="hidden" name="targetId" th:value="${rvo.user.id}">
        </div>
        <div class="text-right mt-2">
            <button type="submit" class="btn btn-primary btn-sm" onclick="#">&nbsp;&nbsp;回&nbsp;&nbsp;复&nbsp;&nbsp;</button>
        </div>
    </form>
</div>
~~~

## 实际效果

<img src="https://gitee.com/hollis7/pictures/raw/master/2024/06/18/17856_image-20240618205331144.png" alt="image-20240618205331144" style="zoom: 80%;" />