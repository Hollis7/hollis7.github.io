---
title: 牛客论坛项目-发送私信
categories:
- nowcoder
tags:
- core_function
- nowcoder
---
<meta name="referrer" content="no-referrer"/>

## 内容

**本节包括：**

- 发送私信
- 设置已读

<!--more-->

## 总体步骤

发送私信

- 采用异步的方式发送私信。
- 发送成功后刷新私信列表。

设置已读

- 访问私信详情时，将显示的私信设置为已读状态

## 数据访问层

### 续写MessageMapper

~~~java
// 新增消息
int insertMessage(Message message);

// 修改消息的状态
int updateStatus(List<Integer> ids, int status);
~~~

### 续写message-mapper.xml

~~~xml
<insert id="insertMessage" parameterType="Message" keyProperty="id">
    insert into message(<include refid="insertFields"></include>)
    values(#{fromId},#{toId},#{conversationId},#{content},#{status},#{createTime})
</insert>

<update id="updateStatus">
    update message set status = #{status}
    where id in
    <foreach collection="ids" item="id" open="(" separator="," close=")">
        #{id}
    </foreach>
</update>

~~~

`<foreach collection="ids" item="id" open="(" separator="," close=")">`:

- 这是一个 MyBatis 的 `foreach` 元素，用于遍历一个集合并生成 SQL 代码片段。
- `collection="ids"` 指定了要遍历的集合名称为 `ids`，这个集合应该是传递给 MyBatis 的参数。
- `item="id"` 指定了在遍历集合时，每个元素的别名为 `id`。
- `open="("` 表示在生成的 SQL 片段的开头加上一个左括号 `(`。
- `separator=","` 表示每个元素之间用逗号 `,` 分隔。
- `close=")"` 表示在生成的 SQL 片段的末尾加上一个右括号 `)`。

## 业务层

### 续写MessageService

~~~java
@Autowired
private SensitiveFilter sensitiveFilter;
public int addMessage(Message message) {
    message.setContent(HtmlUtils.htmlEscape(message.getContent()));
    message.setContent(sensitiveFilter.filter(message.getContent()));
    return messageMapper.insertMessage(message);
}
public int readMessage(List<Integer> ids) {
    return messageMapper.updateStatus(ids, 1);
}
~~~

### 续写MessageController

~~~java
@RequestMapping(path = "/letter/send", method = RequestMethod.POST)
@ResponseBody
public String sendLetter(String toName, String content) {
    User target = userService.findUserByName(toName);
    if (target == null) {
        return CommunityUtil.getJSONString(1, "目标用户不存在!");
    }

    Message message = new Message();
    message.setFromId(hostHolder.getUser().getId());
    message.setToId(target.getId());
    if (message.getFromId() < message.getToId()) {
        message.setConversationId(message.getFromId() + "_" + message.getToId());
    } else {
        message.setConversationId(message.getToId() + "_" + message.getFromId());
    }
    message.setContent(content);
    message.setCreateTime(new Date());
    messageService.addMessage(message);

    return CommunityUtil.getJSONString(0);
}
~~~

userService续写

~~~java
public User findUserByName(String username) {
    return userMapper.selectByName(username);
}
~~~

## 视图层

### 改写letter.js

~~~js
function send_letter() {
    $("#sendModal").modal("hide");
    var toName = $("#recipient-name").val();
    var content = $("#message-text").val();
    $.post(
        CONTEXT_PATH + "/letter/send",
        {"toName": toName, "content": content},
        function (data) {
            data = $.parseJSON(data);
            if (data.code == 0) {
                $("#hintBody").text("发送成功!");
            } else {
                $("#hintBody").text(data.msg);
            }

            $("#hintModal").modal("show");
            setTimeout(function () {
                $("#hintModal").modal("hide");
                location.reload();
            }, 2000);
        }
    );
}
~~~

### 改写letter-detail.html

~~~java
<div class="form-group">
    <label for="recipient-name" class="col-form-label">发给：</label>
    <input type="text" class="form-control" id="recipient-name"
           th:value="${target.username}">
</div>
~~~

## 实际效果

<img src="https://gitee.com/hollis7/pictures/raw/master/2024/06/19/82256_image-20240619202846008.png" alt="image-20240619202846008" style="zoom:50%;" />

## 消息已读功能

### 续写messageController

~~~java
@RequestMapping(path = "/letter/detail/{conversationId}", method = RequestMethod.GET)
public String getLetterDetail(@PathVariable("conversationId") String conversationId, Page page, Model model) {
    ....

    // 设置已读
    List<Integer> ids = getLetterIds(letterList);
    if (!ids.isEmpty()) {
        messageService.readMessage(ids);
    }

    return "/site/letter-detail";
}

private List<Integer> getLetterIds(List<Message> letterList) {
    List<Integer> ids = new ArrayList<>();

    if (letterList != null) {
        for (Message message : letterList) {
            if (hostHolder.getUser().getId() == message.getToId() && message.getStatus() == 0) {
                ids.add(message.getId());
            }
        }
    }

    return ids;
}
~~~

接收者`message.getToId()`是当前用户才将对应id的消息状态置为1