---
title: 牛客论坛项目-显示评论
categories:
- nowcoder
tags:
- core_function
- nowcoder
---
<meta name="referrer" content="no-referrer"/>

## 内容

**本节包括：**

- 评论相关

<!--more-->

## 创建实体Comment

~~~java
@Data
public class Comment {
    private int id;
    private int userId;
    private int entityType;
    private int entityId;
    private int targetId;
    private String content;
    private int status;
    private Date createTime;
}
~~~

## 创建接口CommentMapper

~~~java
@Mapper
public interface CommentMapper {
    List<Comment> selectCommentsByEntity(int entityType, int entityId, int offset, int limit);

    int selectCountByEntity(int entityType, int entityId);

}
~~~

## 创建服务

~~~java
@Service
public class CommentService {

    @Autowired
    private CommentMapper commentMapper;

    public List<Comment> findCommentsByEntity(int entityType, int entityId, int offset, int limit) {
        return commentMapper.selectCommentsByEntity(entityType, entityId, offset, limit);
    }

    public int findCommentCount(int entityType, int entityId) {
        return commentMapper.selectCountByEntity(entityType, entityId);
    }

}
~~~

## 续写DiscussPostController-

~~~java
@Autowired
private CommentService commentService;

@RequestMapping(path = "/detail/{discussPostId}", method = RequestMethod.GET)
public String getDiscussPost(@PathVariable("discussPostId") int discussPostId, Model model, Page page) {
    // 帖子
    DiscussPost post = discussPostService.findDiscussPostById(discussPostId);
    model.addAttribute("post", post);

    // 作者
    User user = userService.findUserById(post.getUserId());
    model.addAttribute("user", user);


    // 评论分页信息
    page.setLimit(5);
    page.setPath("/discuss/detail/" + discussPostId);
    page.setRows(post.getCommentCount());

    // 评论: 给帖子的评论
    // 回复: 给评论的评论
    // 评论列表
    List<Comment> commentList = commentService.findCommentsByEntity(
            ENTITY_TYPE_POST, post.getId(), page.getOffset(), page.getLimit());

    // 评论VO列表
    List<Map<String, Object>> commentVoList = new ArrayList<>();
    if (commentList != null) {
        for (Comment comment : commentList) {
            // 评论VO
            Map<String, Object> commentVo = new HashMap<>();
            // 评论
            commentVo.put("comment", comment);
            // 作者
            commentVo.put("user", userService.findUserById(comment.getUserId()));

            // 回复列表
            List<Comment> replyList = commentService.findCommentsByEntity(
                    ENTITY_TYPE_COMMENT, comment.getId(), 0, Integer.MAX_VALUE);
            // 回复VO列表
            List<Map<String, Object>> replyVoList = new ArrayList<>();
            if (replyList != null) {
                for (Comment reply : replyList) {
                    Map<String, Object> replyVo = new HashMap<>();
                    // 回复
                    replyVo.put("reply", reply);
                    // 作者
                    replyVo.put("user", userService.findUserById(reply.getUserId()));
                    // 回复目标
                    User target = reply.getTargetId() == 0 ? null : userService.findUserById(reply.getTargetId());
                    replyVo.put("target", target);

                    replyVoList.add(replyVo);
                }
            }
            commentVo.put("replys", replyVoList);

            // 回复数量
            int replyCount = commentService.findCommentCount(ENTITY_TYPE_COMMENT, comment.getId());
            commentVo.put("replyCount", replyCount);

            commentVoList.add(commentVo);
        }
        model.addAttribute("comments", commentVoList);
    }
    return "/site/discuss-detail";

}
~~~

## 续写CommunityConstant

~~~java
public interface CommunityConstant {
   ...
    /**
     * 实体类型: 帖子
     */
    int ENTITY_TYPE_POST = 1;

    /**
     * 实体类型: 评论
     */
    int ENTITY_TYPE_COMMENT = 2;
}
~~~

## 改写index.html

~~~html
<li class="d-inline ml-2">回帖 <span th:text="${map.post.commentCount}">7</span></li>
~~~

## 改写discuss-detail.html

### 改写评论

~~~html
<h6><b class="square"></b> <i th:text="${post.commentCount}">30</i>条回帖</h6>
<img th:src="${cvo.user.headerUrl}" class="align-self-start mr-4 rounded-circle user-header" alt="用户头像" >

<span class="font-size-12 text-success" th:utext="${cvo.user.username}">掉脑袋切切</span>
<span class="badge badge-secondary float-right floor">
    <i th:text="${page.offset + cvoStat.count}">1</i>#
</span>
~~~

`<i th:text="${page.offset + cvoStat.count}">1</i>#`当前评论的楼层cvoStat是变量加stat，属于thymeleaf的默认语法，循环变量第几个。

~~~html
<div class="mt-2" th:utext="${cvo.comment.content}">
    这开课时间是不是有点晚啊。。。
</div>
~~~

~~~html
<div class="mt-4 text-muted font-size-12">
<span>发布于 <b th:text="${#dates.format(cvo.comment.createTime,'yyyy-MM-dd HH:mm:ss')}">2019-04-15 15:32:18</b></span>
<ul class="d-inline float-right">
    <li class="d-inline ml-2"><a href="#" class="text-primary">赞(1)</a></li>
    <li class="d-inline ml-2">|</li>
    <li class="d-inline ml-2"><a href="#" class="text-primary">回复(<i th:text="${cvo.replyCount}">2</i>)</a></li>
</ul>
</div>
~~~

### 改写回复

~~~html
<li class="pb-3 pt-3 mb-3 border-bottom" th:each="rvo:${cvo.replys}">
<div>
    <span th:if="${rvo.target==null}">
        <b class="text-info" th:text="${rvo.user.username}">寒江雪</b>:&nbsp;&nbsp;
    </span>
    <span th:if="${rvo.target!=null}">
        <i class="text-info" th:text="${rvo.user.username}">Sissi</i> 回复
        <b class="text-info" th:text="${rvo.target.username}">寒江雪</b>:&nbsp;&nbsp;
    </span>
    <span th:utext="${rvo.reply.content}">这个是直播时间哈，觉得晚的话可以直接看之前的完整录播的~</span>
</div>
~~~

~~~java
<ul class="d-inline float-right">
    <li class="d-inline ml-2"><a href="#" class="text-primary">赞(1)</a></li>
    <li class="d-inline ml-2">|</li>
    <li class="d-inline ml-2"><a th:href="|#huifu-${rvoStat.count}|" data-toggle="collapse" class="text-primary">回复</a></li>
</ul>
<div th:id="|huifu-${rvoStat.count}|" class="mt-4 collapse">
~~~

## 复用首页分页

index分页框取名

~~~html
<nav class="mt-5" th:if="${page.rows>0}" th:fragment="pagination">
~~~

discuss-detail复用

~~~html
<nav class="mt-5" th:replace="index::pagination">
~~~

## 回帖总数统计

~~~java
<li class="d-inline ml-2"><a href="#replyform" class="text-primary">回帖 <i th:text="${post.commentCount}">7</i></a></li>
~~~

## 实际效果

<img src="https://gitee.com/hollis7/pictures/raw/master/2024/06/18/39242_image-20240618192506942.png" alt="image-20240618192506942" style="zoom: 80%;" />
