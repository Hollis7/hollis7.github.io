---
title: 牛客论坛项目-发布帖子
categories:
- nowcoder
tags:
- core_function
- nowcoder
---
<meta name="referrer" content="no-referrer"/>

## 内容

**本节包括：**

- AJAX
- 发布帖子

<!--more-->

## AJAX

Asynchronous JavaScript and XML
异步的JavaScript与XML,不是一门新技术，只是一个新的术语。
使用AJAX,**网页能够将增量更新呈现在页面上，而不需要刷新整个页面**。
虽然X代表XML,但目前SON的使用比XML更加普遍。

## 导入fastjson依赖

~~~xml
<!-- https://mvnrepository.com/artifact/com.alibaba/fastjson -->
<dependency>
    <groupId>com.alibaba</groupId>
    <artifactId>fastjson</artifactId>
    <version>1.2.58</version>
</dependency>
~~~

### 续写CommunityUtil-转化json字符串

~~~java
public static String getJSONString(int code, String msg, Map<String, Object> map) {
        JSONObject json = new JSONObject();
        json.put("code", code);
        json.put("msg", msg);
        if (map != null) {
            for (String key : map.keySet()) {
                json.put(key, map.get(key));
            }
        }
        return json.toJSONString();
    }

    public static String getJSONString(int code, String msg) {
        return getJSONString(code, msg, null);
    }

    public static String getJSONString(int code) {
        return getJSONString(code, null, null);
    }
~~~

## 发布帖子

### 续写DiscussPostMapper-插入帖子

~~~java
int insertDiscussPost(DiscussPost discussPost);
~~~

### 续写discusspost-mapper.xml-实现插入帖子sql

~~~xml
<sql id="insertFields">
    user_id, title, content, type, status, create_time, comment_count, score
</sql>
<insert id="insertDiscussPost" parameterType="DiscussPost">
    insert into discuss_post(<include refid="insertFields"></include>)
    values(#{userId},#{title},#{content},#{type},#{status},#{createTime},#{commentCount},#{score})
</insert>
~~~

### 续写DiscussPostService-添加发布帖子方法

~~~java
@Autowired
private SensitiveFilter sensitiveFilter;
public int addDiscussPost(DiscussPost post) {
    if (post == null) {
        throw new IllegalArgumentException("参数不能为空!");
    }

    // 转义HTML标记
    post.setTitle(HtmlUtils.htmlEscape(post.getTitle()));
    post.setContent(HtmlUtils.htmlEscape(post.getContent()));
    // 过滤敏感词
    post.setTitle(sensitiveFilter.filter(post.getTitle()));
    post.setContent(sensitiveFilter.filter(post.getContent()));

    return discussPostMapper.insertDiscussPost(post);
}
~~~

`HtmlUtils.htmlEscape` 函数的主要作用是将给定的字符串中的特殊字符转换为 HTML 实体。这在处理用户输入或者生成 HTML 内容时非常重要，因为它可以防止 HTML 注入攻击，确保输出内容在浏览器中被安全地渲染。

~~~java
String unsafeString = "<script>alert('XSS')</script>";
String safeString = HtmlUtils.htmlEscape(unsafeString);
// safeString 的值将是 "&lt;script&gt;alert(&#x27;XSS&#x27;)&lt;/script&gt;"
~~~

通过这种转换，浏览器会将 `safeString` 作为普通文本渲染，而不会执行其中的脚本。

### DiscussPostController

~~~java
@Controller
@RequestMapping("/discuss")
public class DiscussPostController {
    @Autowired
    private DiscussPostService discussPostService;

    @Autowired
    private HostHolder hostHolder;

    @RequestMapping(path = "/add", method = RequestMethod.POST)
    @ResponseBody
    public String addDiscussPost(String title, String content) {
        User user = hostHolder.getUser();
        if (user == null) {
            return CommunityUtil.getJSONString(403, "你还没有登录哦!");
        }

        DiscussPost post = new DiscussPost();
        post.setUserId(user.getId());
        post.setTitle(title);
        post.setContent(content);
        post.setCreateTime(new Date());
        discussPostService.addDiscussPost(post);

        // 报错的情况,将来统一处理.
        return CommunityUtil.getJSONString(0, "发布成功!");
    }
}
~~~

### 修改index.js的发布功能

~~~js
$(function(){
	$("#publishBtn").click(publish);
});

function publish() {
	$("#publishModal").modal("hide");

	// 获取标题和内容
	var title = $("#recipient-name").val();
	var content = $("#message-text").val();
	// 发送异步请求(POST)
	$.post(
	    CONTEXT_PATH + "/discuss/add",
	    {"title":title,"content":content},
	    function(data) {
	        data = $.parseJSON(data);
	        // 在提示框中显示返回消息
	        $("#hintBody").text(data.msg);
	        // 显示提示框
            $("#hintModal").modal("show");
            // 2秒后,自动隐藏提示框
            setTimeout(function(){
                $("#hintModal").modal("hide");
                // 刷新页面
                if(data.code == 0) {
                    window.location.reload();
                }
            }, 2000);
	    }
	);

}
~~~

`#hintModal`这些符号都是取得对应index提示框的id值

~~~html
<!-- 提示框 -->
<div class="modal fade" id="hintModal" tabindex="-1" role="dialog" aria-labelledby="hintModalLabel"
 aria-hidden="true">
<div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title" id="hintModalLabel">提示</h5>
        </div>
        <div class="modal-body" id="hintBody">
            发布完毕!
        </div>
    </div>
</div>
</div>
~~~

### 修改index.html发布-验证登录状态

~~~java
<button type="button" class="btn btn-primary btn-sm position-absolute rt-0" data-toggle="modal" data-target="#publishModal" th:if="${loginUser!=null}">我要发布</button>
~~~

