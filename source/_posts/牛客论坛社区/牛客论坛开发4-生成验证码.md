---
title: 牛客论坛项目-生成验证码
categories:
- nowcoder
tags:
- forum
- nowcoder
---
<meta name="referrer" content="no-referrer"/>

## 内容

**本节包括：**

- 生成验证码
- Kaptcha
- 验证码刷新

<!--more-->

## Kaptcha

### 导入jar包

[参考](https://code.google.com/archive/p/kaptcha)

~~~xml
<!-- https://mvnrepository.com/artifact/com.github.penggle/kaptcha -->
<dependency>
    <groupId>com.github.penggle</groupId>
    <artifactId>kaptcha</artifactId>
    <version>2.3.2</version>
</dependency>
~~~

### KaptchaConfig配置类

由于没有整合到springboot，也没有自动配置，需要自己写一个配置类

~~~java
@Configuration
public class KaptchaConfig {
@Bean
public Producer kaptchaProducer() {
    Properties properties = new Properties();
    properties.setProperty("kaptcha.image.width", "100");
    properties.setProperty("kaptcha.image.height", "40");
    properties.setProperty("kaptcha.textproducer.font.size", "32");
    properties.setProperty("kaptcha.textproducer.font.color", "0,0,0");
    properties.setProperty("kaptcha.textproducer.char.string", "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ");
    properties.setProperty("kaptcha.textproducer.char.length", "4");
    properties.setProperty("kaptcha.noise.impl", "com.google.code.kaptcha.impl.NoNoise");

    DefaultKaptcha kaptcha = new DefaultKaptcha();
    Config config = new Config(properties);
    kaptcha.setConfig(config);
    return kaptcha;
}
}
~~~

### LoginController续写-获取图片

~~~java
private static final Logger logger = LoggerFactory.getLogger(LoginController.class);
@Autowired
private Producer kaptchaProducer;

@RequestMapping(path = "/kaptcha", method = RequestMethod.GET)
public void getKaptcha(HttpServletResponse response, HttpSession session) {
    // 生成验证码
    String text = kaptchaProducer.createText();
    BufferedImage image = kaptchaProducer.createImage(text);

    // 将验证码存入session
    session.setAttribute("kaptcha", text);

    // 将突图片输出给浏览器
    response.setContentType("image/png");
    try {
        OutputStream os = response.getOutputStream();
        ImageIO.write(image, "png", os);
    } catch (IOException e) {
        logger.error("响应验证码失败:" + e.getMessage());
    }
}
~~~

### bug

报错`"java.lang.IllegalStateException: No primary or single unique constructor found for interface javax.servlet.http.HttpServletResponse\r\n\tat org.springframework.beans.BeanUtils.`，就是接口没有唯一实现或者优先实现类，但是老师的没有报错，改成导入这个包就没有问题了：

~~~java
import jakarta.servlet.http.HttpServletResponse;
import jakarta.servlet.http.HttpSession;
~~~

在 `Spring Cloud Gateway` 编写的 `Controller` 接口方法，不能用 `javax.servlet.http.HttpServletRequest`，同理感觉`springboot`也是，然后发现之前导入的response包也都是：

~~~java
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
~~~

:smile: :smile: :smile: :smile:

### login.html添加验证码和刷新

~~~html
<div class="col-sm-4">
    <img th:src="@{/kaptcha}" id="kaptcha" style="width:100px;height:40px;" class="mr-2"/>
    <a href="javascript:refresh_kaptcha();" class="font-size-12 align-bottom">刷新验证码</a>
</div>
~~~

并添加js函数

~~~html
<script>
    function refresh_kaptcha() {
        var path = CONTEXT_PATH + "/kaptcha?p=" + Math.random();
        $("#kaptcha").attr("src", path);
    }
</script>
~~~

`var path = CONTEXT_PATH + "/kaptcha?p=" + Math.random();`用来欺骗浏览器链接发生了更改，参数无实际意义。

`$("#kaptcha").attr("src", path);`其中kaptcha是上面刷新验证码的id，src是其属性，用path对其修改。

在global中声明一个全局项目路径

~~~js
var CONTEXT_PATH = "/community";
~~~

