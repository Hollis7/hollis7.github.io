---
title: 牛客论坛项目-显示系统通知
categories:
- nowcoder
tags:
- Redis
- nowcoder
---
<meta name="referrer" content="no-referrer"/>

## 内容

**本节包括：**

- 显示评论、点赞、关注数的数量详情
- 显示系统通知

<!--more-->

## 总体实现

通知列表

- 显示评论、点赞、关注三种类型的通知

通知详情

- 分页显示某一类主题所包含的通知

未读消息

- 在页面头部显示所有的未读消息数量

## 系统消息笼统通知

### 续写MessageMapper

~~~java
// 查询某个主题下最新的通知
Message selectLatestNotice(int userId, String topic);

// 查询某个主题所包含的通知数量
int selectNoticeCount(int userId, String topic);

// 查询未读的通知的数量
int selectNoticeUnreadCount(int userId, String topic);
~~~

### 续写message-mapper.xml

~~~xml
<select id="selectLatestNotice" resultType="com.hdb.community.entity.Message">
    select
    <include refid="selectFields"></include>
    from message
    where id in (
    select max(id) from message
    where status != 2
    and from_id = 1
    and to_id = #{userId}
    and conversation_id = #{topic}
    )
</select>

<select id="selectNoticeCount" resultType="java.lang.Integer">
    select count(id)
    from message
    where status != 2
    and from_id = 1
    and to_id = #{userId}
      and conversation_id = #{topic}
</select>
<select id="selectNoticeUnreadCount" resultType="java.lang.Integer">
    select count(id) from message
    where status = 0
    and from_id = 1
    and to_id = #{userId}
    <if test="topic!=null">
        and conversation_id = #{topic}
    </if>
</select>
~~~

### 续写messageService

~~~java
public Message findLatestNotice(int userId, String topic) {
    return messageMapper.selectLatestNotice(userId, topic);
}

public int findNoticeCount(int userId, String topic) {
    return messageMapper.selectNoticeCount(userId, topic);
}

public int findNoticeUnreadCount(int userId, String topic) {
    return messageMapper.selectNoticeUnreadCount(userId, topic);
}
~~~

### 续写messageController

~~~java
@RequestMapping(path = "/notice/list", method = RequestMethod.GET)
public String getNoticeList(Model model) {
    User user = hostHolder.getUser();

    // 查询评论类通知
    Message message = messageService.findLatestNotice(user.getId(), TOPIC_COMMENT);
    Map<String, Object> messageVO = new HashMap<>();
    if (message != null) {
        messageVO.put("message", message);

        String content = HtmlUtils.htmlUnescape(message.getContent());
        Map<String, Object> data = JSONObject.parseObject(content, HashMap.class);

        messageVO.put("user", userService.findUserById((Integer) data.get("userId")));
        messageVO.put("entityType", data.get("entityType"));
        messageVO.put("entityId", data.get("entityId"));
        messageVO.put("postId", data.get("postId"));

        int count = messageService.findNoticeCount(user.getId(), TOPIC_COMMENT);
        messageVO.put("count", count);

        int unread = messageService.findNoticeUnreadCount(user.getId(), TOPIC_COMMENT);
        messageVO.put("unread", unread);
        model.addAttribute("commentNotice", messageVO);
    }


    // 查询点赞类通知
    message = messageService.findLatestNotice(user.getId(), TOPIC_LIKE);
    messageVO = new HashMap<>();
    if (message != null) {
        messageVO.put("message", message);

        String content = HtmlUtils.htmlUnescape(message.getContent());
        Map<String, Object> data = JSONObject.parseObject(content, HashMap.class);

        messageVO.put("user", userService.findUserById((Integer) data.get("userId")));
        messageVO.put("entityType", data.get("entityType"));
        messageVO.put("entityId", data.get("entityId"));
        messageVO.put("postId", data.get("postId"));

        int count = messageService.findNoticeCount(user.getId(), TOPIC_LIKE);
        messageVO.put("count", count);

        int unread = messageService.findNoticeUnreadCount(user.getId(), TOPIC_LIKE);
        messageVO.put("unread", unread);
    }
    model.addAttribute("likeNotice", messageVO);

    // 查询关注类通知
    message = messageService.findLatestNotice(user.getId(), TOPIC_FOLLOW);
    messageVO = new HashMap<>();
    if (message != null) {
        messageVO.put("message", message);

        String content = HtmlUtils.htmlUnescape(message.getContent());
        Map<String, Object> data = JSONObject.parseObject(content, HashMap.class);

        messageVO.put("user", userService.findUserById((Integer) data.get("userId")));
        messageVO.put("entityType", data.get("entityType"));
        messageVO.put("entityId", data.get("entityId"));

        int count = messageService.findNoticeCount(user.getId(), TOPIC_FOLLOW);
        messageVO.put("count", count);

        int unread = messageService.findNoticeUnreadCount(user.getId(), TOPIC_FOLLOW);
        messageVO.put("unread", unread);
    }
    model.addAttribute("followNotice", messageVO);

    // 查询未读消息数量
    int letterUnreadCount = messageService.findLetterUnreadCount(user.getId(), null);
    model.addAttribute("letterUnreadCount", letterUnreadCount);
    int noticeUnreadCount = messageService.findNoticeUnreadCount(user.getId(), null);
    model.addAttribute("noticeUnreadCount", noticeUnreadCount);

    return "/site/notice";
}
~~~

### 修改letter.html

插入数据和链接

~~~html
<a class="nav-link position-relative" th:href="@{/notice/list}">
    系统通知<span class="badge badge-danger" th:text="${noticeUnreadCount}" th:if="${noticeUnreadCount!=0}">27</span>
</a>
~~~

### 修改notice.html

当前系统通知界面切换颜色

~~~html
<li class="nav-item">
    <a class="nav-link position-relative" th:href="@{/letter/list}">
        朋友私信<span class="badge badge-danger" th:text="${letterUnreadCount}" th:if="${letterUnreadCount!=0}">3</span>
    </a>
</li>
<li class="nav-item">
    <a class="nav-link position-relative active" th:href="@{/notice/list}">
        系统通知<span class="badge badge-danger" th:text="${noticeUnreadCount}" th:if="${noticeUnreadCount!=0}">27</span>
    </a>
</li>
~~~

评论类通知

~~~html
<!--评论类通知-->
<li class="media pb-3 pt-3 mb-3 border-bottom position-relative" th:if="${commentNotice!=null}">
    <span class="badge badge-danger"
          th:text="${commentNotice.unread!=0?commentNotice.unread:''}">3</span>
    <img src="http://static.nowcoder.com/images/head/reply.png" class="mr-4 user-header" alt="通知图标">
    <div class="media-body">
        <h6 class="mt-0 mb-3">
            <span>评论</span>
            <span class="float-right text-muted font-size-12"
                  th:text="${#dates.format(commentNotice.message.createTime,'yyyy-MM-dd HH:mm:ss')}">2019-04-28 14:13:25</span>
        </h6>
        <div>
            <a href="#">
                用户
                <i th:utext="${commentNotice.user.username}">nowcoder</i>
                评论了你的<b th:text="${commentNotice.entityType==1?'帖子':'回复'}">帖子</b> ...
            </a>
            <ul class="d-inline font-size-12 float-right">
                <li class="d-inline ml-2"><span class="text-primary">共 <i
                        th:text="${commentNotice.count}">3</i> 条会话</span></li>
            </ul>
        </div>
    </div>
</li>
~~~

点赞类通知

~~~html
<!--点赞类通知-->
<li class="media pb-3 pt-3 mb-3 border-bottom position-relative" th:if="${likeNotice!=null}">
    <span class="badge badge-danger" th:text="${likeNotice.unread!=0?likeNotice.unread:''}">3</span>
    <img src="http://static.nowcoder.com/images/head/like.png" class="mr-4 user-header" alt="通知图标">
    <div class="media-body">
        <h6 class="mt-0 mb-3">
            <span>赞</span>
            <span class="float-right text-muted font-size-12"
                  th:text="${#dates.format(likeNotice.message.createTime,'yyyy-MM-dd HH:mm:ss')}">2019-04-28 14:13:25</span>
        </h6>
        <div>
            <a href="#">
                用户
                <i th:utext="${likeNotice.user.username}">nowcoder</i>
                点赞了你的<b th:text="${likeNotice.entityType==1?'帖子':'回复'}">帖子</b> ...
            </a>
            <ul class="d-inline font-size-12 float-right">
                <li class="d-inline ml-2"><span class="text-primary">共 <i
                        th:text="${likeNotice.count}">3</i> 条会话</span></li>
            </ul>
        </div>
    </div>
</li>
~~~

### 初步结果

<img src="https://gitee.com/hollis7/pictures/raw/master/2024/06/27/72661_image-20240627213717885.png" alt="image-20240627213717885" style="zoom: 80%;" />

## 系统三大主题通知详情

### 续写MessageMapper

~~~java
 List<Message> selectNotices(int userId, String topic, int offset, int limit);
~~~

### 续写message-mapper.xml

~~~xml
<select id="selectNotices" resultType="com.hdb.community.entity.Message">
    select
    <include refid="selectFields"></include>
    from message
    where status != 2
    and from_id = 1
    and to_id = #{userId}
    and conversation_id = #{topic}
    order by create_time desc
    limit #{offset}, #{limit}
</select>
~~~

### 续写messageService

~~~java
public List<Message> findNotices(int userId, String topic, int offset, int limit) {
    return messageMapper.selectNotices(userId, topic, offset, limit);
}
~~~

### 续写messageController

~~~java
@RequestMapping(path = "/notice/detail/{topic}", method = RequestMethod.GET)
public String getNoticeDetail(@PathVariable("topic") String topic, Page page, Model model) {
    User user = hostHolder.getUser();

    page.setLimit(5);
    page.setPath("/notice/detail/" + topic);
    page.setRows(messageService.findNoticeCount(user.getId(), topic));

    List<Message> noticeList = messageService.findNotices(user.getId(), topic, page.getOffset(), page.getLimit());
    List<Map<String, Object>> noticeVoList = new ArrayList<>();
    if (noticeList != null) {
        for (Message notice : noticeList) {
            Map<String, Object> map = new HashMap<>();
            // 通知
            map.put("notice", notice);
            // 内容
            String content = HtmlUtils.htmlUnescape(notice.getContent());
            Map<String, Object> data = JSONObject.parseObject(content, HashMap.class);
            map.put("user", userService.findUserById((Integer) data.get("userId")));
            map.put("entityType", data.get("entityType"));
            map.put("entityId", data.get("entityId"));
            map.put("postId", data.get("postId"));
            // 通知作者
            map.put("fromUser", userService.findUserById(notice.getFromId()));

            noticeVoList.add(map);
        }
    }
    model.addAttribute("notices", noticeVoList);

    // 设置已读
    List<Integer> ids = getLetterIds(noticeList);
    if (!ids.isEmpty()) {
        messageService.readMessage(ids);
    }

    return "/site/notice-detail";
}
~~~

### 修改notice.html

~~~html
<a th:href="@{/notice/detail/comment}">
<a th:href="@{/notice/detail/follow}">
<a th:href="@{/notice/detail/like}">
~~~

### 修改notice-detail.html

返回系统通知初始页

~~~html
<button type="button" class="btn btn-secondary btn-sm" onclick="back();">返回</button>
<script>
    function back() {
        location.href = CONTEXT_PATH + "/notice/list";
    }
</script>
~~~

通知内容详情

~~~html
<!-- 通知列表 -->
<ul class="list-unstyled mt-4">
    <li class="media pb-3 pt-3 mb-2" th:each="map:${notices}" th:if="${notices!=null}">
        <img th:src="${map.fromUser.headerUrl}" class="mr-4 rounded-circle user-header" alt="系统图标">
        <div class="toast show d-lg-block" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="mr-auto" th:utext="${map.fromUser.username}">落基山脉下的闲人</strong>
                <small th:text="${#dates.format(map.notice.createTime,'yyyy-MM-dd HH:mm:ss')}">2019-04-25
                    15:49:32</small>
                <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="toast-body">
                <span th:if="${topic.equals('comment')}">
                        用户
                        <i th:utext="${map.user.username}">nowcoder</i>
                        评论了你的<b th:text="${map.entityType==1?'帖子':'回复'}">帖子</b>,
                        <a class="text-primary" th:href="@{|/discuss/detail/${map.postId}|}">点击查看</a> !
                </span>
                <span th:if="${topic.equals('like')}">
                        用户
                        <i th:utext="${map.user.username}">nowcoder</i>
                        点赞了你的<b th:text="${map.entityType==1?'帖子':'回复'}">帖子</b>,
                        <a class="text-primary" th:href="@{|/discuss/detail/${map.postId}|}">点击查看</a> !
                </span>
                <span th:if="${topic.equals('follow')}">
                        用户
                        <i th:utext="${map.user.username}">nowcoder</i>
                        关注了你,
                        <a class="text-primary" th:href="@{|/user/profile/${map.user.id}|}">点击查看</a> !
                </span>
            </div>
        </div>
    </li>
</ul>
~~~

关于查看消息还有未读消息的原因：由于controller是分页查看消息，分页更新消息的已读和未读状态，因此如果想要将未读消息清零，需要查看所有分页。

### 初步结果

![image-20240628105645083](https://gitee.com/hollis7/pictures/raw/master/2024/06/28/93697_image-20240628105645083.png)

###  创建MessageInterceptor

~~~java
@Component
public class MessageInterceptor implements HandlerInterceptor {

    @Autowired
    private HostHolder hostHolder;

    @Autowired
    private MessageService messageService;

    @Override
    public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception {
        User user = hostHolder.getUser();
        if (user != null && modelAndView != null) {
            int letterUnreadCount = messageService.findLetterUnreadCount(user.getId(), null);
            int noticeUnreadCount = messageService.findNoticeUnreadCount(user.getId(), null);
            modelAndView.addObject("allUnreadCount", letterUnreadCount + noticeUnreadCount);
        }
    }
}
~~~

### 配置拦截器-续写WebMvcConfig

~~~java
@Autowired
private MessageInterceptor messageInterceptor;

registry.addInterceptor(messageInterceptor)
            .excludePathPatterns("/**/*.css", "/**/*.js", "/**/*.png", "/**/*.jpg", "/**/*.jpeg");
~~~

### 修改Index.html

~~~html
<a class="nav-link position-relative" th:href="@{/letter/list}">消息
    <span class="badge badge-danger"
          th:text="${allUnreadCount!=0?allUnreadCount:''}">12</span>
</a>
~~~

### 最终结果

![image-20240628112150848](https://gitee.com/hollis7/pictures/raw/master/2024/06/28/34400_image-20240628112150848.png)

