---
title: 牛客论坛项目-注册
categories:
- nowcoder
tags:
- forum
- nowcoder
---
<meta name="referrer" content="no-referrer"/>

## 内容

**本节包括：**

- 注册页面
- 提交注册数据
- 激活账号

<!--more-->

## 注册页面

### LoginController

~~~java
@Controller
public class LoginController {
    @RequestMapping(path = "/register", method = RequestMethod.GET)
    public String getRegisterPage() {
        return "/site/register";
    }
}
~~~

### 修改register模板

相对路径要用thymeleaf管理起来

`Register.html`

~~~html
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<link rel="stylesheet" th:href="@{/css/global.css}"/>
<link rel="stylesheet" th:href="@{/css/login.css}"/>
...
~~~

修改`index.html`

~~~html
<!-- 功能 -->
<div class="collapse navbar-collapse" id="navbarSupportedContent">
    <ul class="navbar-nav mr-auto">
        <li class="nav-item ml-3 btn-group-vertical">
            <a class="nav-link" th:href="@{/index}">首页</a>
        </li>
        <li class="nav-item ml-3 btn-group-vertical" th:if="${loginUser==null}">
            <a class="nav-link" th:href="@{/register}">注册</a>
        </li>
</div>
~~~

index的header模板复用

~~~html
<header class="bg-dark sticky-top" th:fragment="header">
~~~

register复用header

~~~html
<header class="bg-dark sticky-top" th:replace="index::header">
~~~

## 提交注册数据

### 导入依赖

~~~xml
<dependency>
    <groupId>org.apache.commons</groupId>
    <artifactId>commons-lang3</artifactId>
    <version>3.9</version>
</dependency>
~~~

### 配置域名

```xml
# community
community.path.domain=http://localhost:8080
community.path.upload=D:/data/community_demo/upload
```

### 随机字符串生成和Md5加密

~~~java
public class CommunityUtil {
    // 生成随机字符串
    public static String generateUUID() {
        return UUID.randomUUID().toString().replaceAll("-", "");
    }

    // MD5加密
    public static String md5(String key) {
        if (StringUtils.isBlank(key)) {
            return null;
        }
        return DigestUtils.md5DigestAsHex(key.getBytes());
    }
}
~~~

### 补充userservice

注册，信息校验，发送邮件

~~~java
public Map<String, Object> register(User user) {
    Map<String, Object> map = new HashMap<>();

    // 空值处理
    if (user == null) {
        throw new IllegalArgumentException("参数不能为空!");
    }
    if (StringUtils.isBlank(user.getUsername())) {
        map.put("usernameMsg", "账号不能为空!");
        return map;
    }
    if (StringUtils.isBlank(user.getPassword())) {
        map.put("passwordMsg", "密码不能为空!");
        return map;
    }
    if (StringUtils.isBlank(user.getEmail())) {
        map.put("emailMsg", "邮箱不能为空!");
        return map;
    }

    // 验证账号
    User u = userMapper.selectByName(user.getUsername());
    if (u != null) {
        map.put("usernameMsg", "该账号已存在!");
        return map;
    }

    // 验证邮箱
    u = userMapper.selectByEmail(user.getEmail());
    if (u != null) {
        map.put("emailMsg", "该邮箱已被注册!");
        return map;
    }

    // 注册用户
    user.setSalt(CommunityUtil.generateUUID().substring(0, 5));
    user.setPassword(CommunityUtil.md5(user.getPassword() + user.getSalt()));
    user.setType(0);
    user.setStatus(0);
    user.setActivationCode(CommunityUtil.generateUUID());
    user.setHeaderUrl(String.format("http://images.nowcoder.com/head/%dt.png", new Random().nextInt(1000)));
    user.setCreateTime(new Date());
    userMapper.insertUser(user);

    // 激活邮件
    Context context = new Context();
    context.setVariable("email", user.getEmail());
    // http://localhost:8080/community/activation/101/code
    String url = domain + contextPath + "/activation/" + user.getId() + "/" + user.getActivationCode();
    context.setVariable("url", url);
    String content = templateEngine.process("/mail/activation", context);
    mailClient.sendMail(user.getEmail(), "激活账号", content);

    return map;
}
~~~

### 修改账号激活html模板

~~~html
<body>
<div>
    <p>
        <b th:text="${email}">xxx@xxx.com</b>, 您好!
    </p>
    <p>
        您正在注册牛客网, 这是一封激活邮件, 请点击
        <a th:href="${url}">此链接</a>,
        激活您的牛客账号!
    </p>
</div>
</body>
~~~

### 补充LoginController

注册信息校验发送激活邮件

~~~java
@Autowired
private UserService userService;

@RequestMapping(path = "/register", method = RequestMethod.POST)
public String register(Model model, User user) {
    Map<String, Object> map = userService.register(user);
    if (map == null || map.isEmpty()) {
        model.addAttribute("msg", "注册成功,我们已经向您的邮箱发送了一封激活邮件,请尽快激活!");
        model.addAttribute("target", "/index");
        return "/site/operate-result";
    } else {
        model.addAttribute("usernameMsg", map.get("usernameMsg"));
        model.addAttribute("passwordMsg", map.get("passwordMsg"));
        model.addAttribute("emailMsg", map.get("emailMsg"));
        return "/site/register";
    }
}
~~~

### 修改注册成功模板operate-result.html

~~~html
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<!-- 内容 --> 
<div class="main">
    <div class="container mt-5">
        <div class="jumbotron">
            <p class="lead" th:text="${msg}">您的账号已经激活成功,可以正常使用了!</p>
            <hr class="my-4">
            <p>
                系统会在 <span id="seconds" class="text-danger">8</span> 秒后自动跳转,
                您也可以点此 <a id="target" th:href="@{${target}}" class="text-primary">链接</a>, 手动跳转!
            </p>
        </div>
    </div>
</div>
~~~

头部复用

~~~html
<header class="bg-dark sticky-top" th:replace="index::header">
~~~

### 继续修改register.html-账号信息输入

~~~html
<form class="mt-5" method="post" th:action="@{/register}">
<div class="form-group row">
    <label for="username" class="col-sm-2 col-form-label text-right">账号:</label>
    <div class="col-sm-10">
        <input type="text"
               th:class="|form-control ${usernameMsg!=null?'is-invalid':''}|"
               th:value="${user!=null?user.username:''}"
               id="username" name="username" placeholder="请输入您的账号!" required>
        <div class="invalid-feedback" th:text="${usernameMsg}">
            该账号已存在!
        </div>
    </div>
</div>
<div class="form-group row mt-4">
    <label for="password" class="col-sm-2 col-form-label text-right">密码:</label>
    <div class="col-sm-10">
        <input type="password"
               th:class="|form-control ${passwordMsg!=null?'is-invalid':''}|"
               th:value="${user!=null?user.password:''}"
               id="password" name="password" placeholder="请输入您的密码!" required>
        <div class="invalid-feedback" th:text="${passwordMsg}">
            密码长度不能小于8位!
        </div>
    </div>
</div>
<div class="form-group row mt-4">
    <label for="confirm-password" class="col-sm-2 col-form-label text-right">确认密码:</label>
    <div class="col-sm-10">
        <input type="password" class="form-control"
               th:value="${user!=null?user.password:''}"
               id="confirm-password" placeholder="请再次输入密码!" required>
        <div class="invalid-feedback">
            两次输入的密码不一致!
        </div>
    </div>
</div>
<div class="form-group row">
    <label for="email" class="col-sm-2 col-form-label text-right">邮箱:</label>
    <div class="col-sm-10">
        <input type="email"
               th:class="|form-control ${emailMsg!=null?'is-invalid':''}|"
               th:value="${user!=null?user.email:''}"
               id="email" name="email" placeholder="请输入您的邮箱!" required>
        <div class="invalid-feedback" th:text="${emailMsg}">
            该邮箱已注册!
        </div>
    </div>
</div>
~~~

`${usernameMsg!=null?'is-invalid':''}`是`is-invalid`会显示报错信息

 `th:value="${user!=null?user.username:''}"`显示默认值

## 激活注册账号

### 定义激活常量

~~~java
package com.hdb.community.util;

public interface CommunityConstant {
    /**
     * 激活成功
     */
    int ACTIVATION_SUCCESS = 0;

    /**
     * 重复激活
     */
    int ACTIVATION_REPEAT = 1;

    /**
     * 激活失败
     */
    int ACTIVATION_FAILURE = 2;

    /**
     * 默认状态的登录凭证的超时时间
     */
    int DEFAULT_EXPIRED_SECONDS = 3600 * 12;

    /**
     * 记住状态的登录凭证超时时间
     */
    int REMEMBER_EXPIRED_SECONDS = 3600 * 24 * 100;
}
~~~

### 续写UserService-激活函数

实现`CommunityConstant`接口

~~~java
@Service
public class UserService implements CommunityConstant{
 ...
    public int activation(int userId, String code) {
    User user = userMapper.selectById(userId);
    if (user.getStatus() == 1) {
        return ACTIVATION_REPEAT;
    } else if (user.getActivationCode().equals(code)) {
        userMapper.updateStatus(userId, 1);
        return ACTIVATION_SUCCESS;
    } else {
        return ACTIVATION_FAILURE;
    }
}
}
~~~

### 续写LoginController-激活控制器

#### 激活结果判断

~~~java
// http://localhost:8080/community/activation/101/code
@RequestMapping(path = "/activation/{userId}/{code}", method = RequestMethod.GET)
public String activation(Model model, @PathVariable("userId") int userId, @PathVariable("code") String code) {
    int result = userService.activation(userId, code);
    if (result == ACTIVATION_SUCCESS) {
        model.addAttribute("msg", "激活成功,您的账号已经可以正常使用了!");
        model.addAttribute("target", "/login");
    } else if (result == ACTIVATION_REPEAT) {
        model.addAttribute("msg", "无效操作,该账号已经激活过了!");
        model.addAttribute("target", "/index");
    } else {
        model.addAttribute("msg", "激活失败,您提供的激活码不正确!");
        model.addAttribute("target", "/index");
    }
    return "/site/operate-result";
}
~~~

#### 登录控制

```java
@RequestMapping(path = "/login", method = RequestMethod.GET)
public String getLoginPage() {
    return "/site/login";
}
```

### 登录页面html

修改路径如前

### 修改index.html

~~~html
<a class="nav-link" th:href="@{/login}">登录</a>
~~~

### 验证码引用

~~~html
<img th:src="@{/img/captcha.png}" style="width:100px;height:40px;" class="mr-2"/>
~~~

