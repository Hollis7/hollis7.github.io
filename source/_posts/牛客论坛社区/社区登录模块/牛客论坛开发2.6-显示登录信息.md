---
title: 牛客论坛项目-显示登录信息
categories:
- nowcoder
tags:
- forum
- nowcoder
---
<meta name="referrer" content="no-referrer"/>

## 内容

**本节包括：**

- 拦截器示例
- 拦截器配置
- 拦截器应用

<!--more-->

## 拦截器示例

### AlphaInterceptor

~~~java
@Component
public class AlphaInterceptor implements HandlerInterceptor {
    private static final Logger logger = LoggerFactory.getLogger(AlphaInterceptor.class);

    // 在Controller之前执行
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        logger.debug("preHandle: " + handler.toString());
        return true;
    }

    // 在Controller之后执行


    @Override
    public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception {
        logger.debug("postHandle: " + handler.toString());
    }

    // 在TemplateEngine之后执行
    @Override
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception {
        logger.debug("afterCompletion: " + handler.toString());
    }
}
~~~

### WebMvcConfig配置

实现`WebMvcConfigurer`接口

~~~java
@Configuration
public class WebMvcConfig implements WebMvcConfigurer {
    @Autowired
    private AlphaInterceptor alphaInterceptor;

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(alphaInterceptor)
                .excludePathPatterns("/**/*.css", "/**/*.js", "/**/*.png", "/**/*.jpg", "/**/*.jpeg")
                .addPathPatterns("/register", "/login");
    }
}
~~~

## 拦截器应用

### 流程

<img src="https://gitee.com/hollis7/pictures/raw/master/2024/06/11/26903_image-20240611150635952.png" alt="image-20240611150635952" style="zoom:25%;" />

### 创建CookieUtil获取cookie

~~~java
package com.hdb.community.util;
public class CookieUtil {
    public static String getValue(HttpServletRequest request, String name) {
        if (request == null || name == null) {
            throw new IllegalArgumentException("参数为空!");
        }

        Cookie[] cookies = request.getCookies();
        if (cookies != null) {
            for (Cookie cookie : cookies) {
                if (cookie.getName().equals(name)) {
                    return cookie.getValue();
                }
            }
        }

        return null;
    }
}
~~~

### 续写userService-通过ticket查询用户

~~~java
public LoginTicket findLoginTicket(String ticket) {
    return loginTicketMapper.selectByTicket(ticket);
}
~~~

### 创建HostHolder代替session对象

~~~java
/**
 * 持有用户信息,用于代替session对象.
 */
@Component
public class HostHolder {

    private ThreadLocal<User> users = new ThreadLocal<>();

    public void setUser(User user) {
        users.set(user);
    }

    public User getUser() {
        return users.get();
    }

    public void clear() {
        users.remove();
    }

}

~~~

#### ThreadLocal

`ThreadLocal` 是 Java 中的一个类，它用于创建线程局部变量。线程局部变量是每个线程都有自己独立的一份变量副本，多个线程之间互不干扰。

- **线程隔离**：`ThreadLocal` 提供每个线程独立的变量副本，从而避免多个线程同时访问同一变量时的线程安全问题。它可以简化多线程编程，不需要显式地进行同步。
- **状态维护**：在一些复杂的框架和应用中，`ThreadLocal` 经常用于保存与线程相关的状态信息。例如，在 Web 应用中，`ThreadLocal` 可以用于存储每个请求的会话信息。

### 创建LoginTicketInterceptor

~~~java
@Component
public class LoginTicketInterceptor implements HandlerInterceptor {

    @Autowired
    private UserService userService;

    @Autowired
    private HostHolder hostHolder;

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        String ticket = CookieUtil.getValue(request, "ticket");
        if (ticket != null) {
            // 查询凭证
            LoginTicket loginTicket = userService.findLoginTicket(ticket);
            // 检查凭证是否有效
            if (loginTicket != null && loginTicket.getStatus() == 0 && loginTicket.getExpired().after(new Date())) {
                // 根据凭证查询用户
                User user = userService.findUserById(loginTicket.getUserId());
                // 在本次请求中持有用户
                hostHolder.setUser(user);
            }
        }

        return true;
    }

    @Override
    public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception {
        User user = hostHolder.getUser();
        if (user != null && modelAndView != null) {
            modelAndView.addObject("loginUser", user);
        }
    }

    @Override
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception {
        hostHolder.clear();
    }
}
~~~

### 续写WebMvcConfig配置-加入LoginTicketInterceptor

~~~java
registry.addInterceptor(loginTicketInterceptor)
        .excludePathPatterns("/**/*.css", "/**/*.js", "/**/*.png", "/**/*.jpg", "/**/*.jpeg");
~~~

### 改写index.html-改写header

`th:if="${loginUser!=null}`

~~~html
<li class="nav-item ml-3 btn-group-vertical" th:if="${loginUser!=null}">
    <a class="nav-link position-relative" href="site/letter.html">消息<span class="badge badge-danger">12</span></a>
</li>
<li class="nav-item ml-3 btn-group-vertical" th:if="${loginUser==null}">
    <a class="nav-link" th:href="@{/register}">注册</a>
</li>
<li class="nav-item ml-3 btn-group-vertical" th:if="${loginUser==null}">
    <a class="nav-link" th:href="@{/login}">登录</a>
</li>
~~~

用户动态头像等

 `<img th:src="${loginUser.headerUrl}" class="rounded-circle" style="width:30px;"/>`

`th:utext="${loginUser.username}"`

~~~html
<li class="nav-item ml-3 btn-group-vertical dropdown" th:if="${loginUser!=null}">
    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        <img th:src="${loginUser.headerUrl}" class="rounded-circle" style="width:30px;"/>
    </a>
    <div class="dropdown-menu" aria-labelledby="navbarDropdown">
        <a class="dropdown-item text-center" href="site/profile.html">个人主页</a>
        <a class="dropdown-item text-center" th:href="@{/user/setting}">账号设置</a>
        <a class="dropdown-item text-center" th:href="@{/logout}">退出登录</a>
        <div class="dropdown-divider"></div>
        <span class="dropdown-item text-center text-secondary" th:utext="${loginUser.username}">nowcoder</span>
    </div>
</li>
~~~



