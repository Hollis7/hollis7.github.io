---
title: 牛客论坛项目-登录和退出
categories:
- nowcoder
tags:
- forum
- nowcoder
---
<meta name="referrer" content="no-referrer"/>

## 内容

**本节包括：**

- 验证账号信息
- 登录凭证
- 退出

<!--more-->

## ticket数据操作

### login_ticket数据库表

```sql
create table login_ticket
(
    id      int auto_increment
        primary key,
    user_id int           not null,
    ticket  varchar(45)   not null,
    status  int default 0 null comment '0-有效; 1-无效;',
    expired timestamp     not null
)
```

### 数据库操作实体类

~~~java
@Data
public class LoginTicket {

    private int id;
    private int userId;
    private String ticket;
    private int status;
    private Date expired;
}
~~~

### Mapper-基于注解

if语句有点麻烦，不方便阅读

~~~java
@Mapper
public interface LoginTicketMapper {
    @Insert({
            "insert into login_ticket(user_id,ticket,status,expired) ",
            "values(#{userId},#{ticket},#{status},#{expired})"
    })
    @Options(useGeneratedKeys = true, keyProperty = "id")
    int insertLoginTicket(LoginTicket loginTicket);

    @Select({
            "select id,user_id,ticket,status,expired ",
            "from login_ticket where ticket=#{ticket}"
    })
    LoginTicket selectByTicket(String ticket);

    @Update({
            "<script>",
            "update login_ticket set status=#{status} where ticket=#{ticket} ",
            "<if test=\"ticket!=null\"> ",
            "and 1=1 ",
            "</if>",
            "</script>"
    })
    int updateStatus(String ticket, int status);
}
~~~

### 测试

~~~java
//插入
@Autowired
private LoginTicketMapper loginTicketMapper;
@Test
public void testInsertLoginTicket() {
    LoginTicket loginTicket = new LoginTicket();
    loginTicket.setUserId(101);
    loginTicket.setTicket("abc");
    loginTicket.setStatus(0);
    loginTicket.setExpired(new Date(System.currentTimeMillis() + 1000 * 60 * 10));

    loginTicketMapper.insertLoginTicket(loginTicket);
}
~~~

~~~java
//查询和更新
@Test
public void testSelectLoginTicket() {
    LoginTicket loginTicket = loginTicketMapper.selectByTicket("abc");
    System.out.println(loginTicket);

    loginTicketMapper.updateStatus("abc", 1);
    loginTicket = loginTicketMapper.selectByTicket("abc");
    System.out.println(loginTicket);
}
~~~

## 登录

### 修改userService-注入ticket

~~~java
@Autowired
private LoginTicketMapper loginTicketMapper;
~~~

~~~java
public Map<String, Object> login(String username, String password, int expiredSeconds) {
    Map<String, Object> map = new HashMap<>();

    // 空值处理
    if (StringUtils.isBlank(username)) {
        map.put("usernameMsg", "账号不能为空!");
        return map;
    }
    if (StringUtils.isBlank(password)) {
        map.put("passwordMsg", "密码不能为空!");
        return map;
    }

    // 验证账号
    User user = userMapper.selectByName(username);
    if (user == null) {
        map.put("usernameMsg", "该账号不存在!");
        return map;
    }

    // 验证状态
    if (user.getStatus() == 0) {
        map.put("usernameMsg", "该账号未激活!");
        return map;
    }

    // 验证密码
    password = CommunityUtil.md5(password + user.getSalt());
    if (!user.getPassword().equals(password)) {
        map.put("passwordMsg", "密码不正确!");
        return map;
    }

    // 生成登录凭证
    LoginTicket loginTicket = new LoginTicket();
    loginTicket.setUserId(user.getId());
    loginTicket.setTicket(CommunityUtil.generateUUID());
    loginTicket.setStatus(0);
    loginTicket.setExpired(new Date(System.currentTimeMillis() + expiredSeconds * 1000));
    loginTicketMapper.insertLoginTicket(loginTicket);

    map.put("ticket", loginTicket.getTicket());
    return map;
}
~~~

### 续写LoginController-提交数据

~~~java
@Value("${server.servlet.context-path}")
private String contextPath;

@RequestMapping(path = "/login", method = RequestMethod.POST)
public String login(String username, String password, String code, boolean rememberme,
                    Model model, HttpSession session, HttpServletResponse response) {
    // 检查验证码
    String kaptcha = (String) session.getAttribute("kaptcha");
    if (StringUtils.isBlank(kaptcha) || StringUtils.isBlank(code) || !kaptcha.equalsIgnoreCase(code)) {
        model.addAttribute("codeMsg", "验证码不正确!");
        return "/site/login";
    }

    // 检查账号,密码
    int expiredSeconds = rememberme ? REMEMBER_EXPIRED_SECONDS : DEFAULT_EXPIRED_SECONDS;
    Map<String, Object> map = userService.login(username, password, expiredSeconds);
    if (map.containsKey("ticket")) {
        Cookie cookie = new Cookie("ticket", map.get("ticket").toString());
        cookie.setPath(contextPath);
        cookie.setMaxAge(expiredSeconds);
        response.addCookie(cookie);
        return "redirect:/index";
    } else {
        model.addAttribute("usernameMsg", map.get("usernameMsg"));
        model.addAttribute("passwordMsg", map.get("passwordMsg"));
        return "/site/login";
    }
}
~~~

`kaptcha.equalsIgnoreCase(code)`这个`equalsIgnoreCase`忽略大小写进行对比。

### 续写login.html-提交表单

~~~html
<form class="mt-5" method="post" th:action="@{/login}">
<input type="text" class="form-control is-invalid" id="username" name="username"
                       placeholder="请输入您的账号!"
                       required>
<input type="password" class="form-control is-invalid" id="password" name="password"
                       placeholder="请输入您的密码!" required>
 <input type="text" class="form-control is-invalid" id="verifycode" name="code"
                           placeholder="请输入验证码!">
 <input type="checkbox" id="remember-me" name="rememberme" checked="checked">
~~~

### 出错或者之后登录显示默认值

`th:value="${param.username}"`可以获取request中存储的value值

~~~html
<input type="text" th:class="|form-control ${usernameMsg!=null?'is-invalid':''}|"
                       th:value="${param.username}"
                       id="username" name="username" placeholder="请输入您的账号!" required>
~~~

### 返回错误信息

~~~html
<input type="text" th:class="|form-control ${codeMsg!=null?'is-invalid':''}|"
   id="verifycode" name="code" placeholder="请输入验证码!">
<div class="invalid-feedback" th:text="${codeMsg}">
验证码不正确!
</div>
~~~

`th:class="|form-control ${codeMsg!=null?'is-invalid':''}|`当这里判断为`is-invalid`，将会打印`codeMsg`

### 续写userService-logout

~~~java
public void logout(String ticket) {
    loginTicketMapper.updateStatus(ticket, 1);
}
~~~

### 续写LoginController-logout

~~~java
@RequestMapping(path = "/logout", method = RequestMethod.GET)
public String logout(@CookieValue("ticket") String ticket) {
    userService.logout(ticket);
    return "redirect:/login";
}
~~~

### 修改index.html-退出链接

这里一定要修改index.html，因为其他模块复用了这个头部

~~~html
<a class="dropdown-item text-center" th:href="@{/logout}">退出登录</a>
~~~
