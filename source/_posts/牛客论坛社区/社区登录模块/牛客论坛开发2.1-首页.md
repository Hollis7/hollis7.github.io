---
title: 牛客论坛项目-首页
categories:
- nowcoder
tags:
- forum
- nowcoder
---
<meta name="referrer" content="no-referrer"/>

## 内容

**本节包括：**

- 首页开发
- 帖子列表处理
- 帖子分页查询

<!--more-->

## 论坛帖子查询

#### 1 数据层

~~~java
package com.hdb.community.dao;
@Mapper
public interface DiscussPostMapper {
    List<DiscussPost> selectDiscussPosts(int userId, int offset, int limit);

    // @Param注解用于给参数取别名,
    // 如果只有一个参数,并且在<if>里使用,则必须加别名.
    int selectDiscussPostRows(@Param("userId") int userId);
}
~~~

~~~xml
<mapper namespace="com.hdb.community.dao.DiscussPostMapper">
<sql id="selectFields">
    id
    , user_id, title, content, type, status, create_time, comment_count, score
</sql>

<select id="selectDiscussPosts" resultType="com.hdb.community.entity.DiscussPost">
    select <include refid="selectFields"></include> from discuss_post where status != 2
    <if test="userId!=0">
        and user_id= #{userId}
    </if>
    order by type desc, create_time desc
    limit #{offset},#{limit}
</select>

<select id="selectDiscussPostRows" resultType="java.lang.Integer">
    select count(id) from discuss_post where status != 2
    <if test="userId!=0">
        and user_id= #{userId}
    </if>
</select>
~~~

注意limit分页和sql语法

#### 2 业务层

~~~java
package com.hdb.community.service;
@Service
public class DiscussPostService {

    @Autowired
    private DiscussPostMapper discussPostMapper;

    public List<DiscussPost> findDiscussPosts(int userId, int offset, int limit) {
        return discussPostMapper.selectDiscussPosts(userId, offset, limit);
    }

    public int findDiscussPostRows(int userId) {
        return discussPostMapper.selectDiscussPostRows(userId);
    }
}
~~~

## 模板黏贴

`css, img, js` 复制到项目static下

`site、index.html`复制到templates目录下

## 开发视图层

### 资源引入修改

资源应用，css，js等路径需要加上th，让thymeleaf自己去寻找static目录下

~~~html
<link rel="stylesheet" th:href="@{/css/global.css}"/>
<script th:src="@{/js/global.js}"></script>
<script th:src="@{/js/index.js}"></script>
~~~

### 控制器

~~~java
@Controller
public class HomeController {
    @Autowired
    private DiscussPostService discussPostService;

    @Autowired
    private UserService userService;

    @RequestMapping(path = "/index", method = RequestMethod.GET)
    public String getIndexPage(Model model) {

        List<DiscussPost> list = discussPostService.findDiscussPosts(0, 0, 10);
        List<Map<String, Object>> discussPosts = new ArrayList<>();
        if (list != null) {
            for (DiscussPost post : list) {
                Map<String, Object> map = new HashMap<>();
                map.put("post", post);
                User user = userService.findUserById(post.getUserId());
                map.put("user", user);
                discussPosts.add(map);
            }
        }
        model.addAttribute("discussPosts", discussPosts);
        return "/index";
    }
}
~~~

map存储数据，存储用户和帖子信息，List数据发送到前端

### 帖子列表处理

删除重复的列表，循环即可

利用thymeleaf的each进行循环

~~~html
 <li class="media pb-3 pt-3 mb-3 border-bottom" th:each="map:${discussPosts}">
~~~

帖子title

~~~html
 <a href="#" th:utext="${map.post.title}">
~~~

判断语句

~~~html
<span class="badge badge-secondary bg-primary" th:if="${map.post.type==1}">置顶</span>
<span class="badge badge-secondary bg-danger" th:if="${map.post.status==1}">精华</span>
~~~

thymeleaf时间格式化

~~~html
<u class="mr-3" th:utext="${map.user.username}">寒江雪</u> 发布于 <b th:text="${#dates.format(map.post.createTime,'yyyy-MM-dd HH:mm:ss')}">2019-04-15 15:32:18</b>
~~~

`#dates.format(var,'yyyy-MM-dd HH:mm:ss')`是thymeleaf内置的时间格式化工具，`yyyy-MM-dd HH:mm:ss`是开发者填入的参数

### 分页封装

#### Page

~~~java
public class Page {

    // 当前页码
    private int current = 1;
    // 显示上限
    private int limit = 10;
    // 数据总数(用于计算总页数)
    private int rows;
    // 查询路径(用于复用分页链接)
    private String path;

    public int getCurrent() {
        return current;
    }
    ...
     /**
     * 获取当前页的起始行
     *
     * @return
     */
    public int getOffset() {
        // current * limit - limit
        return (current - 1) * limit;
    }

    /**
     * 获取总页数
     *
     * @return
     */
    public int getTotal() {
        // rows / limit [+1]
        if (rows % limit == 0) {
            return rows / limit;
        } else {
            return rows / limit + 1;
        }
    }

    /**
     * 获取起始页码
     *
     * @return
     */
    public int getFrom() {
        int from = current - 2;
        return from < 1 ? 1 : from;
    }

    /**
     * 获取结束页码
     *
     * @return
     */
    public int getTo() {
        int to = current + 2;
        int total = getTotal();
        return to > total ? total : to;
    }
}
~~~

set方法需要做一些校验

#### html配置

~~~html
<nav class="mt-5" th:if="${page.rows>0}">
    <ul class="pagination justify-content-center">
        <li class="page-item">
            <a class="page-link" th:href="@{${page.path}(current=1)}">首页</a>
        </li>
        <li th:class="|page-item ${page.current==1?'disabled':''}|">
            <a class="page-link" th:href="@{${page.path}(current=${page.current-1})}">上一页</a></li>
        <li th:class="|page-item ${i==page.current?'active':''}|"
            th:each="i:${#numbers.sequence(page.from,page.to)}">
            <a class="page-link" th:href="@{${page.path}(current = ${i})}" th:text="${i}">1</a>
        </li>
        <li th:class="|page-item ${page.current==page.total?'disabled':''}|">
            <a class="page-link" th:href="@{${page.path}(current=${page.current+1})}">下一页</a>
        </li>
        <li class="page-item">
            <a class="page-link" th:href="@{${page.path}(current=${page.total})}">末页</a>
        </li>
    </ul>
</nav>
~~~

`${page.current==1?'disabled':''`是首页不可以点击上一页

`th:class="|page-item ${i==page.current?'active':''}|"`点亮当前页按钮

`th:each="i:${#numbers.sequence(page.from,page.to)}"`生成from到to的页码遍历

> current参数会传入Page的对应变量中，每次点击下一页或者上一页，会重新跳转到新的`index？current=x`，调用后端函数查询数据库。
