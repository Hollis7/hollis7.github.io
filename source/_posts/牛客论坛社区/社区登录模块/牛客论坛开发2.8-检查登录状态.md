---
title: 牛客论坛项目-检查登录状态
categories:
- nowcoder
tags:
- forum
- nowcoder
---
<meta name="referrer" content="no-referrer"/>

## 内容

**本节包括：**

- 使用拦截器
- 自定义注解

<!--more-->

## 使用拦截器

在方法前标注自定义注解
拦截所有请求，只处理带有该注解的方法

## 常用元注解

### @Target

`@Target` 注解用于指定另一个注解可以应用于哪些Java元素上。它的值是一个 `ElementType` 数组，可以是以下之一或多个：

`ElementType.TYPE`: 应用于类、接口（包括注解类型）或枚举声明。

`ElementType.FIELD`: 应用于字段（包括枚举常量）。

`ElementType.METHOD`: 应用于方法。

`ElementType.PARAMETER`: 应用于方法参数。

`ElementType.CONSTRUCTOR`: 应用于构造函数。

`ElementType.LOCAL_VARIABLE`: 应用于局部变量。

`ElementType.ANNOTATION_TYPE`: 应用于注解类型。

`ElementType.PACKAGE`: 应用于包声明。

`ElementType.TYPE_PARAMETER`: 应用于类型参数。

`ElementType.TYPE_USE`: 应用于类型使用。

### @Retention

`@Retention` 注解指定了注解的保留策略，它的值是 `RetentionPolicy` 枚举，可以是以下之一：

- `RetentionPolicy.SOURCE`: 注解只在源代码中保留，编译时会被丢弃。
- `RetentionPolicy.CLASS`: 注解在编译时保留，但在运行时不会被JVM保留（默认行为）。
- `RetentionPolicy.RUNTIME`: 注解在运行时保留，可以通过反射获取。

### @Document

### @Inherited

## 创建声明

~~~java
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface LoginRequired {
}
~~~

### UserController添加LoginRequired

~~~java
@LoginRequired
@RequestMapping(path = "/setting", method = RequestMethod.GET)
~~~

~~~java
@LoginRequired
@RequestMapping(path = "/upload", method = RequestMethod.POST)
~~~

## 添加拦截器LoginRequiredInterceptor

~~~java
@Component
public class LoginRequiredInterceptor implements HandlerInterceptor {

    @Autowired
    private HostHolder hostHolder;

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        if (handler instanceof HandlerMethod) {
            HandlerMethod handlerMethod = (HandlerMethod) handler;
            Method method = handlerMethod.getMethod();
            LoginRequired loginRequired = method.getAnnotation(LoginRequired.class);
            if (loginRequired != null && hostHolder.getUser() == null) {
                response.sendRedirect(request.getContextPath() + "/login");
                return false;
            }
        }
        return true;
    }
}
~~~

`if (handler instanceof HandlerMethod)`：检查处理器对象是否是`HandlerMethod`的实例。

## 续写WebMvcConfigurer-注入拦截器

排除静态资源

~~~java
@Autowired
private LoginRequiredInterceptor loginRequiredInterceptor;

@Override
    public void addInterceptors(InterceptorRegistry registry) {
	...
    registry.addInterceptor(loginRequiredInterceptor)
            .excludePathPatterns("/**/*.css", "/**/*.js", "/**/*.png", "/**/*.jpg", "/**/*.jpeg");
    }
~~~

